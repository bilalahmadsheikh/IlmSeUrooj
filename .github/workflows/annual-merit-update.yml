name: Annual Merit List Update

on:
  schedule:
    # Run yearly on August 1st (after admission season ends)
    - cron: '0 0 1 8 *'
  workflow_dispatch:
    inputs:
      year:
        description: 'Year for merit data (leave empty for current year)'
        required: false
        default: ''

env:
  NODE_VERSION: '20'
  NOTIFICATION_EMAIL: 'ba8516127@gmail.com'

permissions:
  contents: read
  issues: write

concurrency:
  group: annual-merit-update
  cancel-in-progress: true

jobs:
  fetch-merit-data:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Validate environment
        run: |
          if [ -z "${{ env.NODE_VERSION }}" ]; then
            echo "::error::NODE_VERSION is not set"
            exit 1
          fi

      - name: Determine merit year
        id: year
        run: |
          INPUT_YEAR="${{ github.event.inputs.year }}"
          if [ -z "$INPUT_YEAR" ]; then
            MERIT_YEAR=$(date +%Y)
          else
            MERIT_YEAR="$INPUT_YEAR"
          fi
          echo "value=$MERIT_YEAR" >> $GITHUB_OUTPUT
          echo "ðŸ“… Merit year: **$MERIT_YEAR**" >> $GITHUB_STEP_SUMMARY

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      # Cache previous merit reports to avoid re-scraping same year
      - name: Cache merit reports
        uses: actions/cache@v4
        with:
          path: reports/merit-*
          key: merit-report-${{ steps.year.outputs.value }}

      - name: Fetch merit data from sources
        id: fetch-merit
        run: node scripts/scrapers/merit-scraper.js
        env:
          MERIT_YEAR: ${{ steps.year.outputs.value }}

      - name: Generate merit report
        run: node scripts/generate-merit-report.js

      - name: Upload merit report
        uses: actions/upload-artifact@v4
        with:
          name: merit-report-${{ steps.year.outputs.value }}
          path: reports/merit-report.md
          retention-days: 30

      - name: Create Issue for Manual Review
        uses: actions/github-script@v7
        env:
          MERIT_YEAR: ${{ steps.year.outputs.value }}
        with:
          script: |
            const fs = require('fs');
            const report = fs.existsSync('reports/merit-report.md') 
              ? fs.readFileSync('reports/merit-report.md', 'utf8')
              : 'No report generated';
            
            const meritYear = process.env.MERIT_YEAR;
            
            // Check if issue already exists for this year
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'merit-update,yearly',
              state: 'open'
            });
            
            const existingIssue = issues.find(i => i.title.includes(meritYear));
            if (existingIssue) {
              // Update existing issue instead of creating duplicate
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ðŸ”„ Updated Merit Data (Re-run)\n\n\`\`\`\n${report.substring(0, 2000)}\n\`\`\`\n\n*Updated: ${new Date().toISOString()}*`
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
              return;
            }
            
            const issueBody = [
              '## Merit List Update Required - Manual Review',
              '',
              `This is an automated issue to update merit list data for **${meritYear}**.`,
              '',
              '### Sources Checked',
              '- learnospot.com/fast-university-closing-merits/',
              '- paklearningspot.com (COMSATS, GIKI, NUST, UET)',
              '- Reddit r/FASTNU',
              '- Official university Facebook pages',
              '',
              '### Scraped Data Preview',
              '```',
              report.substring(0, 2000),
              '```',
              '',
              '### Action Required',
              '1. Review the scraped merit data',
              '2. Verify against official sources',
              '3. Update src/components/AdmissionPredictor/AdmissionPredictor.js',
              '4. Update src/data/universities.js descriptions',
              '5. Update docs/DATA-SOURCES.md',
              '6. Close this issue when complete',
              '',
              '---',
              '*This is an automated issue. Manual verification is required before updating.*'
            ].join('\n');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“Š Annual Merit List Update - ${meritYear}`,
              body: issueBody,
              labels: ['merit-update', 'manual-review', 'yearly']
            });

      - name: Write summary
        run: |
          echo "### âœ… Merit Update Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Year: **${{ steps.year.outputs.value }}**" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Issue created for manual review" >> $GITHUB_STEP_SUMMARY
          echo "- Merit report uploaded as artifact" >> $GITHUB_STEP_SUMMARY

      - name: Send notification email
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: 'ðŸ“Š IlmSeUrooj - Annual Merit Update Review Required'
          to: ${{ env.NOTIFICATION_EMAIL }}
          from: IlmSeUrooj Bot
          body: |
            The annual merit list update workflow has completed for ${{ steps.year.outputs.value }}.
            
            A GitHub Issue has been created for manual review.
            Please review the scraped merit data and update the website.
            
            This requires MANUAL REVIEW before updating.
