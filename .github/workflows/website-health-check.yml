name: Website Health Check

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  NOTIFICATION_EMAIL: 'ba8516127@gmail.com'

permissions:
  contents: read
  issues: write

concurrency:
  group: website-health-check
  cancel-in-progress: true

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Validate environment
        run: |
          if [ -z "${{ env.NODE_VERSION }}" ]; then
            echo "::error::NODE_VERSION is not set"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        continue-on-error: true
        id: build

      - name: Run lint checks
        run: npm run lint
        continue-on-error: true
        id: lint

      - name: Check data files integrity
        run: node scripts/validators/data-integrity.js
        continue-on-error: true
        id: data-check

      - name: Check university source URLs
        run: node scripts/utils/url-checker.js
        continue-on-error: true
        id: url-check

      - name: Generate health report
        run: |
          mkdir -p reports
          echo "# Website Health Check Report" > reports/health-report.md
          echo "Date: $(date)" >> reports/health-report.md
          echo "" >> reports/health-report.md
          echo "| Check | Status |" >> reports/health-report.md
          echo "|-------|--------|" >> reports/health-report.md
          echo "| Build | ${{ steps.build.outcome }} |" >> reports/health-report.md
          echo "| Lint | ${{ steps.lint.outcome }} |" >> reports/health-report.md
          echo "| Data Integrity | ${{ steps.data-check.outcome }} |" >> reports/health-report.md
          echo "| URL Check | ${{ steps.url-check.outcome }} |" >> reports/health-report.md

      - name: Write workflow summary
        run: |
          echo "### üè• Website Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.build.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ steps.lint.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Data Integrity | ${{ steps.data-check.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL Check | ${{ steps.url-check.outcome }} |" >> $GITHUB_STEP_SUMMARY

      - name: Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: health-report
          path: reports/health-report.md
          retention-days: 30

      - name: Create issue on failure
        if: steps.build.outcome == 'failure' || steps.data-check.outcome == 'failure'
        uses: actions/github-script@v7
        env:
          BUILD_OUTCOME: ${{ steps.build.outcome }}
          LINT_OUTCOME: ${{ steps.lint.outcome }}
          DATA_CHECK_OUTCOME: ${{ steps.data-check.outcome }}
          URL_CHECK_OUTCOME: ${{ steps.url-check.outcome }}
          RUN_ID: ${{ github.run_id }}
          REPO_FULL: ${{ github.repository }}
        with:
          script: |
            const issueBody = [
              '## Health Check Failure',
              '',
              '| Check | Status |',
              '|-------|--------|',
              `| Build | ${process.env.BUILD_OUTCOME} |`,
              `| Lint | ${process.env.LINT_OUTCOME} |`,
              `| Data Integrity | ${process.env.DATA_CHECK_OUTCOME} |`,
              `| URL Check | ${process.env.URL_CHECK_OUTCOME} |`,
              '',
              'Please investigate and fix the issues.',
              '',
              `[View workflow run](https://github.com/${process.env.REPO_FULL}/actions/runs/${process.env.RUN_ID})`
            ].join('\n');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ö†Ô∏è Website Health Check Failed - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['bug', 'health-check']
            });

      - name: Send failure notification
        if: steps.build.outcome == 'failure' || steps.data-check.outcome == 'failure'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: '‚ö†Ô∏è IlmSeUrooj - Website Health Check Failed'
          to: ${{ env.NOTIFICATION_EMAIL }}
          from: IlmSeUrooj Bot
          body: |
            The daily website health check has detected issues.
            
            Build: ${{ steps.build.outcome }}
            Lint: ${{ steps.lint.outcome }}
            Data Integrity: ${{ steps.data-check.outcome }}
            URL Check: ${{ steps.url-check.outcome }}
            
            View details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
